name: 'Publish to the Vaadin Directory'

on:
  push:
    branches: [ testdirectory ]
    
jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Cache local Maven repository
      uses: actions/cache@v2
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    - name: Cache local NPM
      uses: actions/cache@v2
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    - uses: actions/checkout@v2
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Build with Maven
      run: mvn -B install -Pdirectory --file pom.xml
    - name: Rename the war and remove the version
      run: mv sortable-layout/target/sortable-layout*.zip sortable-layout.zip
    - name: curl to the Vaadin Directory
      uses: wei/curl@v1
      with:
        args: -X POST "https://vaadin.com/vaadincom/directory-service/upload/sortable-layout" -F "authKey=${{ secrets.DIRECTORY_AUTH_KEY }}" -F "publish=false" -F "releaseNotes=test" -H "accept:\ */*" -H "Content-Type:\ multipart/form-data" -F "file=@sortable-layout.zip;type=application/zip"
